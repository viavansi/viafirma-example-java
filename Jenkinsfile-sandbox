pipeline {
    agent {
        node {
            label 'registry'
        }
    }
    stages {
        stage('Git clone'){
            steps{
                git branch:"sandbox" ,url: 'git@github.com:viavansi/viafirma-platform-example-java.git'
            }
        }
        // Launch compile and sonar
        stage('Build'){
                    steps{
                        sh "mvn -U clean package -P tomcat6 sonar:sonar -Dsonar.host.url=${env.SONAR_SERVER} -Dmaven.test.skip=true"
                     }
                }

        stage('Build Docker'){
            steps{
                sh "./build.sh sandbox"
             }
        }

        stage('Deploy'){
            steps{
                sh "./deploy-sandbox.sh"
            }
        }
    }
    post {
        always {
            archiveArtifacts artifacts: '**/*.war', onlyIfSuccessful: true, fingerprint: true
        }
    }
}
